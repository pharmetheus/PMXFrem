% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/createFFEMdata.R
\name{createFFEMdata}
\alias{createFFEMdata}
\title{createFFEMdata}
\usage{
createFFEMdata(
  runno = NULL,
  numNonFREMThetas,
  modName = NULL,
  numFREMThetas = length(grep("THETA", names(dfext))) - numNonFREMThetas,
  covSuffix = "FREMCOV",
  parNames = paste("Par", 1:numParCov, sep = ""),
  numParCov = NULL,
  numSkipOm = 0,
  dataFile,
  newDataFile = paste("vpcData", runno, ".csv", sep = ""),
  availCov = covNames,
  idvar = "ID",
  modDevDir = NULL,
  quiet = FALSE,
  cores = 1,
  dfext = NULL,
  ...
)
}
\arguments{
\item{runno}{The run number.}

\item{numNonFREMThetas}{Number of thetas that are not FREM covariates. These need to come before the FREM covariate thetas.}

\item{modName}{The model name. Default is the current directory, i.e. ".".}

\item{numFREMThetas}{The number thetas associated with FREM covariate effects.}

\item{covSuffix}{Use to create the column name fo rthe covariate effects columns. The column names will be the parameter name followed by this string.}

\item{parNames}{Names of the parameters}

\item{numParCov}{Number of parameters for which covariate relations are sought (often the same as numNonFREMThetas).
default (NULL) indicates that this is guessed by the function by assuming that each covariate effect is modelled as one theta and one eta.}

\item{numSkipOm}{Number of diag omegas (variances) that should not be part of the FREM calculations. 
Such omegas has to come before the large FREM omega block.}

\item{dataFile}{The name of the data file used in the base model, i.e. the original data file, or a data.frame with the same data.}

\item{newDataFile}{The name of a new data file with the FFEM columns added. Default is vpcData{runno}.csv. If NULL, will return a data frame with the data instead of writing it to disk.}

\item{availCov}{Names of the covariates to use in the calculation of the FFEM model.}

\item{idvar}{The name of the ID column,}

\item{modDevDir}{The directory where the files reside.}

\item{quiet}{If FALSE, will print the FFEM model + associated $OMEGA BLOCK}

\item{cores}{How many cores to use in the calculations of the FFEM expressions.}

\item{dfext}{A data frame of the ext file for the model. In case of multiple $EST, the dfext 
should contain the estimates of the *one* relevant $EST.}
}
\value{
A list with objects:
\itemize{
\item Omega: The omega prim matrix to be used in tm model file. The upper triangle is set to NAs.
\item Coefficients: An nPar x nCov matrix with covariate coefficients used to compute the individual covariate effects.
\item indCovEff: A character vector with the labels for the individual covariate effects. Used for the new columns in the new data set.
\item newData: A data.frame with the new data set, i.e. the same as dataFile with individual covariate effects appended.
}
If newDataFile is not NULL, newData will be printed as a csv to disk with the name newData. If quiet is FALSE, the FFEM expressions and new OMEGA matrix is printed in the console.
}
\description{
Add combined FFEM coefficients to the data set for the specified covariates.
}
\details{
This function will compute a combined term of all (FREM) covariate effects for each parameter in the FFEM model and create a
new data file with these combined effects appended. The combined coefficients are added to the FFEM data set with names that
appends COV to the parameter name, e.g. the column with the combined covariate efftecs for parameter PAR will be called PARCOV.
All rows for an individual will have the same value for PARCOV.

To implement an FFEM model with the covariate effects from the FREM analysis, change the FFEM model from:

PAR = TVPAR * EXP(ETA)

to

PAR = TVPAR * EXP(ETA + PARCOV)

the estimated FREM covariate effects will now impact PAR.(The PARCOV term should be added to the corresponding ETA).

To run a VPC for a FREM model, follow the following steps
\enumerate{
\item Create the VPC data set using this (createFFEMdata) function.
\item Modify the FFEM model so that:
\itemize{
\item $DATA specifies the name of the vpc data file.
\item $INPUT includes the new columns.
\item the combined covariate coefficients are added to the etas (as above).
\item the initial estimates of the structural model thetas and sigmas are set to the estimates from the FREM model.
\item the initial estimate of the OMEGA BLOCK are set to be omega matrix that is printed in the terminal from the createFFEMdata function (need to set quiet=FALSE).
\item the $SIM and $TABLE records are appropriately set.
}
\item Run the modified model :)
}
}
\examples{
\dontrun{

data <- read_csv(system.file("extdata/SimNeb/DAT-2-MI-PMX-2-onlyTYPE2-new.csv", package = "PMXFrem"),show_col_types = FALSE) \%>\%
filter(BLQ!=1)

## Check with specified parameter names
vpcData <- createFFEMdata(modName          = "run31",
                          modDevDir        = system.file("extdata/SimNeb/", package = "PMXFrem"),
                          parNames         = c("CL","V","MAT"),
                          numNonFREMThetas = 7,
                          numSkipOm        = 2,
                          dataFile         = data,
                          newDataFile      = NULL,
                          quiet            = TRUE)


}
}
