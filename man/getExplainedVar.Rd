% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/getExplainedVar.R
\name{getExplainedVar}
\alias{getExplainedVar}
\title{Calculate the explained variability for covariates in a FREM model.}
\usage{
getExplainedVar(
  type = 1,
  data,
  dfCovs,
  dfext = NULL,
  strID = "ID",
  runno = NULL,
  modName = NULL,
  modDevDir = ".",
  cstrCovariates = NULL,
  functionList = list(function(basethetas, covthetas, dfrow, etas, ...) {
    
    return(basethetas[1] * exp(covthetas[1] + etas[1]))
 }),
  functionListName = "PAR1",
  numNonFREMThetas,
  numFREMThetas = length(grep("THETA", names(dfext))) - numNonFREMThetas,
  numSigmas = length(grep("SIGMA", names(dfext))),
  numParCov = NULL,
  parNames = NULL,
  numSkipOm = 0,
  availCov = NULL,
  etas = NULL,
  quiet = FALSE,
  ncores = 1,
  cstrPackages = NULL,
  cstrExports = NULL,
  numETASamples = 100,
  seed = NULL,
  ...
)
}
\arguments{
\item{type}{How the total variability should be derived. See Details.}

\item{data}{the data.frame with dataset to base the explained variability
on, used with type=1-3}

\item{dfCovs}{A data frame with covariates to based the variability plots on}

\item{dfext}{a data frame with the final estimates in a ext-file format}

\item{strID}{the subject identifier in the dfCovs dataset, default='ID'}

\item{runno}{The run number. Must be provided if \code{modName} is NULL. Will be
used to create NONMEM model and results file names  with the structure
run#.mod and run#. NONMEM ext, phi and cov files will be assumed to be
named run# followed by the appropriate suffix (where # is \code{runno}).}

\item{modName}{The model name. Will be used together with \code{modExt}, \code{lstExt},
ext, phi and cov to form the NONMEM file names, for example
\code{modName}.mod for the model file.}

\item{modDevDir}{The directory where the files reside. Default is the current
directory, i.e. ".".}

\item{cstrCovariates}{A string vector with names of the covariates that
should be investigated, i.e. must have the same length as the number of
rows in dfCovs. If NULL then COV1, COV2 etc. will be used.}

\item{functionList}{Can either be a list of functions with input (basethetas,
covthetas,dfrow and ...) for which the explained variability will be
calculated, or a function that returns a vector of values. , each value will be
used but functionListName must contain the names with a length of all
return for all functions in the functionList}

\item{functionListName}{A vector of strings (names) for the parameters generated by functionList.}

\item{numNonFREMThetas}{Number of structural thetas in FREM model}

\item{numFREMThetas}{Number of covariate thetas in FREM model}

\item{numSigmas}{Number of sigmas in FREM model}

\item{numParCov}{Number of parameters for which covariate relations are
sought (often the same as numNonFREMThetas).}

\item{parNames}{Names of the parameters}

\item{numSkipOm}{Number of Omegas that are not associated with FREM
covariates, i.e. skip before calculating the FREM varianes, default= 0}

\item{availCov}{Names of the covariates to use in the calculation of the FFEM
model, default=NULL (use all covariates)}

\item{etas}{the etas used to calculate the explained variability, used with
type=1 and should be the same size as number of individuals in data. If
\code{NULL} when type=1 the estas will be obtained from the phi-file.}

\item{quiet}{If output should be allowed during the function call, default=
FALSE,}

\item{ncores}{the number of cores to use for the calculations, default = 1
which means no parallellization}

\item{cstrPackages}{a character vector with the packages needed to run
calculations in parallel, default = NULL}

\item{cstrExports}{a character vector with variables needed to run the
calculations in parallel, default = NULL}

\item{numETASamples}{(default = 100) the number of samples used ot integrate
over individual parameters when calculating the total variance of the
functionList, only used using type==2 & type==3}

\item{seed}{(default = -1 = random, used when sampling ETAs in type==2 and
type==3)}

\item{...}{additional variables to be forwarded to the the functionList
functions}
}
\value{
A data frame with summary statistics for each parameters and
covariate combinations. There will be one row for each parameter-covariate
combination + one row for each partameter with the combination of all
covariates.
\itemize{
\item COVNUM: The covariate number. Repeated per PARAMETER. 1 is the explained variability of All covariates.
\item COVNAME: The name of the covariate as specified in the original data set.
\item PARAMETER: The name(s) of the parameter(s).
\item TOTVAR: The total variability according to \code{type}. Repeated for each parameter-covariate combination.
\item TOTCOVVAR: The total variability explained when all covariates are used.Repeated for each parameter-covariate combination.
\item COVVAR: The variability explained by each covariate by itself.
}
}
\description{
Get a data frame with explainable variability information based on a dataset
of subjects with covariates
}
\details{
The total variability of the metric (e.g. a primary or secondary parameter)
is derived from the FREM model from the estimated multivariate OMEGA matrix,
estimated EBEs, or sampled ETAs from the estimated multivariate OMEGA matrix,
and setting the FREM covariate coefficients to zero. There are four
alternatives that can be requested via the type argument.

\strong{type=0:} Use the the delta rule (FO approximation) to derive the total variability
of the metric across the involved omegas. The first row in dfCovs is used for values of
any FFEM covariates.

\strong{type=1:} Use the estimated EBEs and calculate the variance of the desired
metric across the individuals in the data set. Requires etas or a phi-file
associated with the model. The default method to calculate the total
variability.

\strong{type=2:} Use numETASamples sampled eta vectors from the
estimated multivariate omega matrix to compute numETASamples values of the
metric. The total variability is the average (over all individuals) of the
variances of the numETASamples values of the metrics.

\strong{type=3:} Use numETASamples sampled eta vectors from the
estimated multivariate omega matrix to compute numETASamples values of the
metric for one individual (the first) in the data set. The total variability
is the variance of the numETASamples values of the metric.

If there are no FFEM covariate relationships in the model, then type 2 and 3
are identical, but type=3 will be faster.

type=0 will be fast but not always accurate.

type=1 will also be relatively fast and handles FFEM covariates, but is
sensitive to shrinkage and small data sets.

type=2 is the slowest way to calculate the total variability but handles FFEM
covariates and is not sensitive to shrinkage.

type=3 is not sensitive to shrinkage and is preferred over type=2 if there
are no FFEM covariates.

The \code{availCov} argument specifies the covariates in the frem model that should be used for the calculations
of the maximum variability (TOTCOVVAR). If NULL (default), all covariates inteh frem model will be used for the derivation of TOTCOVVAR.
}
\examples{
library(dplyr)
library(magrittr)

modDevDir <- system.file("extdata/SimNeb",package="PMXFrem")
fremRunno <- 31
modFile   <- file.path(modDevDir,paste0("run",fremRunno,".mod"))
covNames  <- getCovNames(modFile = modFile)

## Set up dfCovs
dfData <- read.csv(system.file("extdata/SimNeb/DAT-2-MI-PMX-2-onlyTYPE2-new.csv", package = "PMXFrem")) \%>\%
  filter(BLQ == 0) \%>\%
  distinct(ID,.keep_all = TRUE)

dfCovs <- setupdfCovs(modFile)

cstrCovariates <- c("All",names(dfCovs))

## A list of functions
functionList2 <- list(
  function(basethetas,covthetas, dfrow, etas, ...){ return(basethetas[2]*exp(covthetas[1] + etas[3]))},
  function(basethetas,covthetas, dfrow, etas, ...){ return(basethetas[3]*exp(covthetas[2] + etas[4]))}
)

functionListName2 <- c("CL","V")

dfres1 <- getExplainedVar(type             = 1,
                          data             = dfData,
                          dfCovs           = dfCovs,
                          numNonFREMThetas = 7,
                          numSkipOm        = 2,
                          functionList     = functionList2,
                          functionListName = functionListName2,
                          cstrCovariates   = cstrCovariates,
                          modDevDir        = modDevDir,
                          runno            = fremRunno,
                          ncores           = 2,
                          quiet            = TRUE,
                          seed             = 123
)

## A fucntion that returns a vecotr of values
vectorFunction <- function(basethetas,covthetas, dfrow, etas, ...) {
  return(
    c(basethetas[2]*exp(covthetas[1] + etas[3]),
      basethetas[3]*exp(covthetas[2] + etas[4]))
)
}

dfres12 <- getExplainedVar(type            = 0,
                          data             = dfData,
                          dfCovs           = dfCovs,
                          numNonFREMThetas = 7,
                          numSkipOm        = 2,
                          functionList     = list(vectorFunction), # Need to enclose the function in list()
                          functionListName = functionListName2,
                          cstrCovariates   = cstrCovariates,
                          modDevDir        = modDevDir,
                          runno            = fremRunno,
                          ncores           = 2,
                          quiet            = TRUE,
                          seed             = 123
)
}
