---
title: "Modifying FREM Models with updateFREMmodel"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Modifying FREM Models with updateFREMmodel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### **Introduction**

The Full Random Effects Model (FREM) is a powerful technique for covariate analysis. The PMXFrem package provides the updateFREMmodel function to manage these complex models without needing to manually edit NONMEM code and data files.

This vignette demonstrates the primary capabilities of updateFREMmodel:

* Removing covariates from an existing model.  
* Adding new covariates to a model.  
* Adding new individuals to an existing FREM dataset.  
* Updating a model's initial parameter estimates from a NONMEM output file.

### **Setup**

First, we load the PMXFrem package. The examples below use model and data files included with the package. We will define paths to these files using system.file() to ensure the examples are reproducible. We will also create a temporary directory for any new files generated by the function.

```{r}
# Load the package
library(PMXFrem)
library(dplyr) # For data manipulation in examples

# Create a temporary directory for output files
td <- tempdir()

# Define paths to example files included in the PMXFrem package
frem_model_path <- system.file("extdata/SimNeb/run31.mod", package = "PMXFrem")
frem_ext_path <- system.file("extdata/SimNeb/run31.ext", package = "PMXFrem")
frem_data_path <- system.file("extdata/SimNeb/frem_dataset.dta", package = "PMXFrem")
ffem_data_path <- system.file("extdata/SimNeb/DAT-2-MI-PMX-2-onlyTYPE2-new.csv", package = "PMXFrem")

# The original model file needs its corresponding .ext file for some operations
# We'll copy it to our temporary directory to ensure our function can find it
file.copy(frem_model_path, td)
file.copy(frem_ext_path, td)
model_in_td <- file.path(td, "run31.mod")

```

### **Use Case 1: Removing Covariates**

A common task is to simplify an existing model by removing covariates. Here, we will remove the covariates WT and SEX from the run31.mod model.

The function needs to know the structure of the base model to correctly modify the parameter lists. This is specified with numNonFREMThetas (the number of $THETA records for the base model) and numSkipOm (the number of $OMEGA diagonals for the base model, e.g., for residual error).

```{r}
# Run updateFREMmodel to remove two covariates
result_remove <- updateFREMmodel(
  strFREMModel      = model_in_td,
  strFREMData       = frem_data_path,
  strFFEMData       = ffem_data_path,
  cstrRemoveCov     = c("SEX", "WT"),
  strNewFREMData    = file.path(td, "frem_data_no_sex_wt.csv"),
  numNonFREMThetas  = 7,
  numSkipOm         = 2,
  bWriteData        = TRUE, # Write the new, smaller dataset
  bWriteMod         = TRUE,  # Write the new, simpler model file
  quiet             = TRUE,
  sortFREMDataset  = c("ID","TIME","FREMTYPE"),
  cstrKeepCols = c("ID","TIME","AMT","EVID","RATE","DV","FOOD","FREMTYPE")
)

# The new model file will be at:
new_model_path_remove <- file.path(td, "run31_new.mod")
print(paste("New model file created at:", new_model_path_remove))

```

**What happened?**

* updateFREMmodel read the input model and data files.  
* The removeFremCovariates helper function was called internally to filter the dataset, removing all rows where FREMTYPE corresponded to WT or SEX, and then re-numbered the remaining FREMTYPEs.  
* The parameter lists ($THETA, $OMEGA) were adjusted to remove the parameters for WT and SEX.  
* A new, smaller data file (frem\_data\_no\_sex\_wt.csv) and a new, simpler model file (run31\_new.mod) were written to our temporary directory. The $DATA record in the new model file was updated to point to the new data file.

### **Use Case 2: Adding Covariates**

Now, let's take the simpler model we just created and add a new covariate to it. We will add the continuous covariate AGE.

```{r}
# The model generated in the previous step is our input
model_to_add_to <- new_model_path_remove
data_to_add_to <- file.path(td, "frem_data_no_sex_wt.csv")

# We need the .ext file for the model we are updating
# We'll copy the original and rename it to match
file.copy(file.path(td, "run31.ext"), file.path(td, "run31_new.ext"))

result_add <- updateFREMmodel(
  strFREMModel      = model_to_add_to,
  strFREMData       = data_to_add_to,
  strFFEMData       = ffem_data_path,
  cstrContCovsToAdd = "AGE", # Specify the continuous covariate to add
  strNewFREMData    = file.path(td, "frem_data_with_age.csv"),
  numNonFREMThetas  = 7,
  numSkipOm         = 2,
  bWriteData        = TRUE,
  bWriteMod         = TRUE,
  quiet             = TRUE,
  sortFREMDataset  = c("ID","TIME","FREMTYPE"),
  cstrKeepCols = c("ID","TIME","AMT","EVID","RATE","DV","FOOD","FREMTYPE")
)

print(paste("A new model was created at:", file.path(td, "run31_new_new.mod")))

```

**What happened?**

* The prepareNewCovariates helper was called to analyze the AGE column in the strFFEMData file. It calculated the mean and variance to use as initial estimates for the new $THETA and $OMEGA entries, and assigned a new FREMTYPE.  
* The augmentFremData helper added new rows to the dataset for the AGE covariate for every individual.  
* The generateFremModel helper added the new MU\_/COV code, $THETA, and $OMEGA records to the model file.  
* A new data file and a new model file were written to disk.

### **Use Case 3: Adding New Individuals**

A key feature is the ability to use a finished FREM model to process new subjects without rerunning the entire analysis. Here, we add 10 new (simulated) individuals to our original run31 dataset.

```{r}
# Load the original FREM and FFEM data as data frames
frem_df <- as.data.frame(data.table::fread(frem_data_path)) %>% 
  select(-ODV)
ffem_df <- as.data.frame(data.table::fread(ffem_data_path)) 

# To simulate new individuals, we'll take a subset of the FFEM data
# and give them new, unique IDs.
ffem_new_ids <- ffem_df[ffem_df$ID <= 10, ] # Use first 10 subjects
ffem_new_ids$ID <- ffem_new_ids$ID + max(frem_df$ID)

# The function will add these new individuals to the existing FREM data
result_new_ids <- updateFREMmodel(
  strFREMModel      = model_in_td,
  strFREMData       = frem_df, # Pass the data as a data frame object
  strFFEMData       = ffem_new_ids,
  strNewFREMData    = file.path(td, "frem_data_with_new_ids.csv"),
  numNonFREMThetas  = 7,
  numSkipOm         = 2,
  bWriteData        = TRUE, # Set to TRUE to get the new data file
  bWriteMod         = FALSE, # The model structure itself doesn't change
  quiet             = TRUE,
  cstrKeepCols     = c("ID", "TIME", "AMT", "DV", "EVID", "RATE", "FREMTYPE"),
  cstrSetToZero     = c("AMT", "EVID", "RATE")
)

# Check that new IDs were added
original_max_id <- max(frem_df$ID)
new_max_id <- max(result_new_ids$data$ID)
print(paste("Original max ID:", original_max_id))
print(paste("New max ID:", new_max_id))

```

**What happened?**

* The initializeModelParameters helper read the final estimates from the .ext file associated with strFREMModel.  
* Because strUpdateType was "NoData", the data processing steps were all skipped.  
* The generateFremModel helper used the parameter values read from the .ext file to write new $THETA and $OMEGA blocks.  
* A new model file was written to disk with the updated initial estimates.



