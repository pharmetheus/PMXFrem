---
title: "Generate standard diagnostics for a FREM model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate standard diagnostics for a FREM model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(GGally))
suppressPackageStartupMessages(library(ggpubr))

theme_set(ggplot2::theme_bw(base_size=20))
```

## Introduction

Just like with any other model it is important to check that FREM models satisfy basic diagnostic tests, for example goodness-of-fit (GOF) plots of DV versus PRED and CWRES versus TIME. Unlike standard models, some of variables of interest are not directly available from the FREM model itself but will have to be derived based on an FFEM version of the model. 

## Create the FFEM model

Create the FFEM model for the set of covariates to include in the model to be evaluated.Consult the [companion vignette](create_FFEM_model.html) on how to set up the FFEM model and generate the necessary output.


```{r}
modDevDir <- system.file("extdata/SimNeb",package="PMXFrem")
dataFile  <- system.file("extdata/SimNeb/DAT-2-MI-PMX-2-onlyTYPE2-new.csv",package="PMXFrem")
fremRun   <- 31
baseRun   <- 30
```

## Comparison of standard diagnostiocs input from Base, FREM and FFEM model

```{r}
xptabBase <- fread(paste0(modDevDir,"/xptab",baseRun),data.table=FALSE,check.names = T) %>%
  filter(BLQ==0,EVID==0) %>% 
    arrange(ID,TAD)

xptabFFEM <- fread(paste0(modDevDir,"/xptabmax0",baseRun),data.table=FALSE,check.names = T) %>%
  filter(BLQ==0,EVID==0) %>% 
  arrange(ID,TAD)

xptabFREM <- fread(paste0(modDevDir,"/xptab",fremRun),data.table=FALSE,check.names = T) %>%
  filter(BLQ==0,EVID==0,FREMTYPE==0) %>% 
    arrange(ID,TAD)

cwresData <- bind_cols(Base=xptabBase$CWRES, FREM=xptabFREM$CWRES, FFEM=xptabFFEM$CWRES) 
iwresData <- bind_cols(Base=xptabBase$CIWRES,FREM=xptabFREM$CIWRES,FFEM=xptabFFEM$CIWRES)
predData  <- bind_cols(Base=xptabBase$CPRED, FREM=xptabFREM$CPRED, FFEM=xptabFFEM$CPRED)
ipredData <- bind_cols(Base=xptabBase$CIPREDI,FREM=xptabFREM$CIPREDI,FFEM=xptabFFEM$CIPREDI)
```

It is only the population predictions that are the same between the three models. IPRED, CWRES, and IWRES are different
```{r,fig.width=10,fig.height=6}
ggpairs(predData)   + ggtitle("PRED")
```

The individual predictions are not the same.
```{r,fig.width=10,fig.height=6}
ggpairs(ipredData)  + ggtitle("IPRED")
```

The CWRES are not identical
```{r,fig.width=10,fig.height=6}
ggpairs(cwresData)  + ggtitle("CWRES")
```

The IWRES are not identical
```{r,fig.width=10,fig.height=6}

ggpairs(iwresData)  + ggtitle("IWRES")
```

## Creating basic GOF plots

```{r,fig.width=10,fig.height=10}

## DV vs PRED
p1 <- xptabFFEM %>% 
  ggplot(aes(exp(CPRED),exp(DV))) +
  geom_point(color="#508791") +
  geom_abline(slope = 1,intercept = 0,size=2) +
  geom_smooth(se = FALSE,color="red") +
  xlab("Populaiton predicitions") +
  ylab("Observations")


## DV vs IPRED
p2 <-xptabFFEM %>% 
  ggplot(aes(exp(CIPREDI),exp(DV))) +
  geom_point(color="#508791") +
  geom_abline(slope = 1,intercept = 0,size=2) +
  geom_smooth(se = FALSE,color="red") +
  xlab("Individual predicitions") +
  ylab("Observations")

## abs(IWRES) vs IPRED
p3 <- xptabFFEM %>% 
  ggplot(aes(abs(CIWRES),exp(CIPREDI))) +
  geom_point(color="#508791") +
  geom_smooth(se = FALSE,color="red") +
  xlab("Individual predicitions") +
  ylab("Absolute IWRES")

## CWRES vs IPRED
p4 <- xptabFFEM %>% 
  ggplot(aes(exp(CPRED),CWRES)) +
  geom_point(color="#508791") +
  geom_abline(slope = 0,intercept = 0,size=2) +
  geom_smooth(se = FALSE,color="red") +
  xlab("Population predicitions") +
  ylab("Conditional weighted residuals")

ggarrange(p1,p2,p3,p4,ncol=2,nrow=2)

```



