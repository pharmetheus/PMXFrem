---
title: "Create a FREM forest plot"
author: "Joakim Nyberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This Vignette explains how to use the FREM package to create a Forest plot based on a FREM run with associated uncertainty. The uncertainty could be a covariance step from NONMEM (a `.cov` file), a sir/bootstrap run from PsN (`raw_results` file) or just a data frame of parameter vectors based on some other method of deriving uncertainty. 

The creation of the plot is divded into the following steps:

* Pre-requisite setup
* Creation of forest data based on pre-requisite data
* Creation of forest ggplot based on forest data

<!-- Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format: -->

<!-- - Never uses retina figures -->
<!-- - Has a smaller default figure size -->
<!-- - Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style -->

## Setting up the pre-requisite

Load the package and identify which NONMEM FREM run that is going to be used for the forest plot.

```{r echo=FALSE, message=FALSE}

library(FREMfunctions) #Read in the FREMfunctions package
library(zoo)           #Zoo only needed for this example

```

```{r}

strRunDir<-"./"        #The directory where the FERM model is located
strRunno<-"run7"       #The FREM model used to produce the forest plot

extFile<-paste0(strRunDir,strRunno,".ext") #The full path of the ext file
modFile<-paste0(strRunDir,strRunno,".mod") #The full path of the mod file
covFile<-paste0(strRunDir,strRunno,".cov") #The full path of the cov file


```

```{r, echo=FALSE} 
#Internal code for Vingette paths
extFile<-system.file("extdata", paste0(strRunno,".ext"), package = "FREMfunctions")
modFile<-system.file("extdata", paste0(strRunno,".mod"), package = "FREMfunctions")
covFile<-system.file("extdata", paste0(strRunno,".cov"), package = "FREMfunctions")
```

Get the parameter estimates and the covnames from the FREM model

```{r} 

dfExt<-subset(FREMfunctions::getExt(extFile = extFile),ITERATION=="-1000000000") #Get the final parameter estimates
covNames<-FREMfunctions::getCovNames(modFile = modFile) #Get the covariate names from the annotated FREM model file

```

Setup a data frame with covariates values that should be used in the forest plot, both multivariate and univariate combinations can be used. Univariate is indicated by only assigning a covariate value one covariate in a row in the data frame. Multivariate is when more then one covariate value is set. A forest-box (y-axis element) of the forest plot will be created for each row in the `dfCovs` dataset. `-99` or `NA` is used to indicate that a covariate should not be used.

```{r} 

dfCovs<-data.frame(LBWT=c(3.12,5.13,4.72,-99,-99,-99,-99,-99,-99),
                   LBLBW=c(3.3,-99,-99,-99,-99,3.3,3.8,-99,-99),
                   LBBSA=c(-99,-99,-99,0.79,0.91,-99,-99,0.45,-99))

print(dfCovs)

# Or similarly

dfCovs<-dfCreateInputForestData(list(
                            list("LBWT"=c(3.12,5.13,4.72),"LBLBW"=c(3.3)),
                             "LBBSA"=c(0.79,0.91),
                             "LBLBW"=c(3.3,3.8),
                             "LBBSA"=c(0.45,-99)),
                        iMiss=-99)

```

In this first example the forest plot will be based on the covariance matrix for NONMEM `.cov`file. After reading in the covariance matrix, multivariate samples will be drawn for the a multivariate normal with the mean as the final estimates and covariance matrix as the uncertainty from NONMEM:


```{r}
### Read in the covariance matrix if available
if (file.exists(covFile)) {  
  ### Read the cov file
  dfcov<-read.table(covFile,fill=TRUE,header=TRUE,sep="",skip=1,stringsAsFactors=FALSE)
  sigma<-data.matrix(dfcov[,2:ncol(dfcov)])
}

mu<-as.numeric(dfExt[,-(c(1,ncol(dfExt)))]) #The mean is the final estimates
dfParameters<-as.data.frame(FREMfunctions::mvrnorm_vector(mu=mu,sigma = sigma,iSampleIndex = 100)) #Draw 100 samples from cov matrix
dfParameters<-cbind(dfParameters,OBJ=0) #Add a dummy column with the OBJ to make it look more like a ext file

```

As a last step of the pre-requisite, a list of functions that defines the parameter that the forest plot created for are listed. This functional list is based on a only the fixed effects, i.e. no random effects are needed. Also note that the functional form for this covariate-parameter relationship is dependet on the parameter functional form, usually lognormal $CL=\theta_{CL} \cdot exp(\eta_{CL})$, as well as the covariate form in the FREM model, usually normal $COV=\theta_{COV}+\eta_{COV}$. The example below assumes lognormal parameters with normal FREM covariate relationships:

```{r}
#The parameter function list
functionList=list(function(basethetas,covthetas,...){return(basethetas[1]*exp(covthetas[1]))}, 
                                     function(basethetas,covthetas,...){return(basethetas[2]*exp(covthetas[2]))})
#Name of the parameters
functionListName=c("CL","V1")
```

## Get the forest plot data

The data for the forest plot can now be generated based on the pre-requisite information:

```{r}
dfres<-getForestDF(dfCovs = dfCovs,
                   noBaseThetas = 6,noCovThetas = length(covNames$covNames),noSigmas = 2,
                   dfParameters=dfParameters,covNames=covNames,
                   functionList=functionList,functionListName=functionListName,
                   quiet=TRUE,withingroupdist = 0.3)

print(dfres)

```

Each row in the output corresponds to an errorbar in the forest plot. Grouping of the covariates are automatically detected based on `dfCovs` and visible in the `GROUP` column. `REFMEDIAN`, `REFMEAN` and `REFTRUE` are all based on the reference set of covariates (no covariates per default) and based on the median, mean and final parameter estimate. A default row-name is created and available in the `COVNAME` column and based on the information in `dfCovs`.
The columns `q1` and `q3` are per default the 95\% confidence interval for the covariate values and  `q2` is the median value (per default).  `Y` is mainly used in the plot function but could be alterd to change the apperance of the forest plot. The `dfCovs` information is also included for each row.


## Produce the forest plot

The `getForestDF()` output could be directly used to produce a default forest plot.


```{r, fig1,fig.height = 4, fig.width = 16, fig.align="center", out.width=700, out.height=175}
theme_set(theme_bw(base_size=22)) #Change ggplot defaults to get nice plot
plotForestDF(dfres,textsize=6)
```


