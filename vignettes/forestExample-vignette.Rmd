---
title: "Create a FREM forest plot"
author: "Joakim Nyberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This Vignette explains how to use the FREM package to create a Forest plot based on a FREM run with associated uncertainty. 
The uncertainty may be a covariance step from NONMEM (a `.cov` file), a sir/bootstrap run from PsN (`raw_results` file) or just a data frame of parameter vectors 
based on some other method of deriving uncertainty. 

The creation of the plot is divded into the following steps:

* Pre-requisite setup
* Creation of forest data based on pre-requisite data
* Creation of forest ggplot based on forest data

## Setting up the pre-requisite

Load the package and identify which NONMEM FREM run that is going to be used for the forest plot.

```{r echo=TRUE, warning=FALSE,message=FALSE}
library(FREMfunctions) # Read in the FREMfunctions package
```

```{r}
runDir <- "../inst/extdata/"            # The directory where the FREM model is located
runno  <- "run7"                        # The FREM model used to produce the forest plot

extFile <- paste0(runDir,runno,".ext") # The full path to the ext file
modFile <- paste0(runDir,runno,".mod") # The full path to the mod file
covFile <- paste0(runDir,runno,".cov") # The full path to the cov file
```

```{r, echo=FALSE} 
#Internal code for Vingette paths
extFile <- system.file("extdata", paste0(runno,".ext"), package = "FREMfunctions")
modFile <- system.file("extdata", paste0(runno,".mod"), package = "FREMfunctions")
covFile <- system.file("extdata", paste0(runno,".cov"), package = "FREMfunctions")
```

Get the parameter estimates and the covaraite names from the FREM model.

```{r} 

dfExt    <- subset(getExt(extFile = extFile),ITERATION=="-1000000000") # Get the final parameter estimates
covNames <- getCovNames(modFile = modFile)                             # Get the covariate names from the annotated FREM model file

```

Setup a data frame with covariates values that should be used in the forest plot, both multivariate and univariate combinations can be used. Univariate is indicated by only assigning ine covariate value 
in a row in the data frame. Multivariate is when more then one covariate value is set. A forest-box (y-axis element) of the forest plot will be created for each row in the `dfCovs` dataset. `-99` or `NA` is 
used to indicate that a covariate should not be used.

```{r} 

dfCovs<-data.frame(LBWT  = c(3.12,4.6,4.3,-99,-99,-99,-99,-99,-99),
                   LBLBW = c(3.3,-99,-99,-99,-99,3.3,3.8,-99,-99),
                   LBBSA = c(-99,-99,-99,0.79,0.91,-99,-99,0.45,-99))

print(dfCovs)

# There is also a utility function to accomplish the same if the setup is more complicated.
dfCovs <- dfCreateInputForestData(
  list(
    list("LBWT" = c(3.12,4.6,4.3),"LBLBW"=c(3.3)),
    "LBBSA" = c(0.56,0.75),
    "LBLBW" = c(3.3,3.8)),
  iMiss=-99)

print(dfCovs)
```

In this example the forest plot will be based on the covariance matrix from the NONMEM `.cov` file. 
After reading in the covariance matrix, multivariate samples will be drawn from the a multivariate normal with the means taken as the final parameter estimates and the covariance matrix taken as the uncertainty matrix (from `.cov`) from NONMEM


```{r}
## Read in the covariance matrix if available
if (file.exists(covFile)) {  
  dfcov <- read.table(covFile,fill=TRUE,header=TRUE,sep="",skip=1,stringsAsFactors=FALSE)
  sigma <- data.matrix(dfcov[,2:ncol(dfcov)])
}

mu           <- as.numeric(dfExt[,-(c(1,ncol(dfExt)))])                               # The mean is the final estimates
dfParameters <- as.data.frame(mvrnorm_vector(mu=mu,sigma = sigma,iSampleIndex = 100)) # Draw 100 samples from cov matrix
dfParameters <- cbind(dfParameters,OBJ=0)                                             # Add a dummy column with the OBJ to make it look more like a ext file

```

As a last step of the pre-requisite we need to create a list of functions that will be used to calculate the parameter that the forest plot will visualise. 
This list of functions use only the fixed effects, i.e. no random effects are needed. 
Also note that the functional form for the covariate-parameter relationships are dependet on the parameter functional form, 
usually lognormal $CL=\theta_{CL} \cdot exp(\eta_{CL})$, as well as the covariate form in the FREM model, usually normal $COV=\theta_{COV}+\eta_{COV}$. 
The example below assumes lognormal parameters with normal FREM covariate relationships.

```{r}
## The parameter function list
functionList <- list(
  function(basethetas,covthetas,...){ return(basethetas[1]*exp(covthetas[1]))}, 
  function(basethetas,covthetas,...){ return(basethetas[2]*exp(covthetas[2]))}
  )

## Define the names of the parameters that each of the functions in the list above returns
functionListName <- c("CL","V1")
```

## Get the forest plot data

The data for the forest plot can now be generated based on the pre-requisite information.
```{r, warning=FALSE}
dfres <- getForestDF(dfCovs = dfCovs,
                     noBaseThetas = 6,noCovThetas = length(covNames$covNames),noSigmas = 2,
                     dfParameters=dfParameters,covNames=covNames,
                     functionList=functionList,functionListName=functionListName,
                     quiet=TRUE,withingroupdist = 0.3,cores=1)

print(dfres)
```

Each row in the output corresponds to an errorbar in the forest plot. Grouping of the covariates are automatically detected based on `dfCovs` and visible in the `GROUP` column. 
`REFMEDIAN`, `REFMEAN` and `REFTRUE` are all based on the reference set of covariates (no covariates per default) and based on the median, mean and final parameter estimate. 
A default row-name is created and available in the `COVNAME` column and based on the information in `dfCovs`.
The columns `q1` and `q3` are per default the 95\% confidence interval for the covariate values and  `q2` is the median value (per default).  
`Y` is mainly used in the plot function but could be alterd to change the apperance of the forest plot. The `dfCovs` information is also included for each row.


## Create the Forest plot

The `plotForestDF` funciton takes the `getForestDF()` output to produce the Forest plot.


```{r, fig1,fig.height = 4, fig.width = 16, fig.align="center", out.width=700, out.height=175}
theme_set(theme_bw(base_size=22)) #Change ggplot defaults to get nice plot
plotForestDF(dfres,textsize=6)
```



