---
title: "Create a FREM forest plot"
author: "Joakim Nyberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


This Vignette explains how to use the FREM package to create a Forest plot based on a FREM run with associated uncertainty. 
The uncertainty may be a covariance step from NONMEM (a `.cov` file), a sir/bootstrap run from PsN (`raw_results` file) or just a data frame of parameter vectors 
based on some other method of deriving uncertainty. 

The creation of the plot is divided into the following steps:

* Pre-requisite setup
* Creation of forest data based on pre-requisite data
* Creation of forest ggplot based on forest data

## Setting up the pre-requisite

Load the package and identify which NONMEM FREM run that is going to be used for the forest plot.

```{r echo=TRUE, warning=FALSE,message=FALSE}


library(PMXFrem) # Read in the FREMfunctions package

library(PMXForest) #Read in the forest package for showing the covariate effects

library(ggplot2) #Read in the ggplot2 package for plotting

set.seed(865765) #Set seed for reproducability


```

```{r} 
#Get the Vingette paths to ext, cov and mod file
runno<-"run7"
extFile <- system.file("extdata", paste0(runno,".ext"), package = "PMXFrem")
modFile <- system.file("extdata", paste0(runno,".mod"), package = "PMXFrem")
covFile <- system.file("extdata", paste0(runno,".cov"), package = "PMXFrem")
```

Get the parameter estimates and the covariate names from the FREM model.

```{r} 

dfExt    <- subset(PMXFrem::getExt(extFile = extFile),ITERATION=="-1000000000") # Get the final parameter estimates
covNames <- PMXFrem::getCovNames(modFile = modFile)                             # Get the covariate names from the annotated FREM model file

```

Setup a data frame with covariates values that should be used in the forest plot, both multivariate and univariate combinations can be used. Univariate is indicated by only assigning one covariate value 
in a row in the data frame. Multivariate is when more then one covariate value is set. A forest-box (y-axis element) of the forest plot will be created for each row in the `dfCovs` dataset. `-99` or `NA` is used to indicate that a covariate should not be used.

```{r} 

dfCovs<-data.frame(LBWT  = c(3.12,4.6,4.3,-99,-99,-99,-99,-99),
                   LBLBW = c(3.3,-99,-99,-99,-99,3.3,3.8,-99),
                   LBBSA = c(-99,-99,-99,0.56,0.75,-99,-99,-99))

print(dfCovs)

# There is also a utility function to accomplish the same if the setup is more complicated.
dfCovs <- PMXForest::createInputForestData(
  list(
    list("LBWT" = c(3.12,4.6,4.3),"LBLBW"=c(3.3)), #First 3 rows
    "LBBSA" = c(0.56,0.75),                        #Row 4,5
    "LBLBW" = c(3.3,3.8),                          #Row 6,7   
    list("LBWT"=NA,"LBBSA"=NA,"LBLBW"=NA)),        #Last row, reference row
  iMiss=-99)

print(dfCovs)
```

In this example the forest plot will be based on the covariance matrix from the NONMEM `.cov` file. 
After reading in the covariance matrix, multivariate samples will be drawn from the a multivariate normal with the means taken as the final parameter estimates and the covariance matrix taken as the uncertainty matrix (from `.cov`) from NONMEM


```{r}
#Get 100 samples from the cov file
dfParameters<-PMXForest::getSamples(covFile,extFile = extFile,n = 100)

## Set the first sample to the final estimates
dfParameters[1,]<-dfExt[1,-1]
```

As a last step of the pre-requisite we need to create a list of functions that will be used to calculate the parameter(s) that the forest plot will visualize. 
This functions specified in the list of functions only access the fixed effects, i.e. no random effects are needed. 

Also note that the functional form for the covariate-parameter relationships are dependent on the parameter functional form, 
usually lognormal $CL=\theta_{CL} \cdot exp(\eta_{CL})$, as well as the covariate form in the FREM model, usually normal $COV=\theta_{COV}+\eta_{COV}$. 
The example below assumes lognormal parameters with normal FREM covariate relationships.

```{r}
## The parameter function list
functionList <- list(
  function(basethetas,covthetas,...){ return(basethetas[1]*exp(covthetas[1]))}, 
  function(basethetas,covthetas,...){ return(basethetas[2]*exp(covthetas[2]))}
  )

## Define the names of the parameters that each of the functions in the list above returns
functionListName <- c("CL","V1")
```

## Get the forest plot data

The data for the forest plot can now be generated based on the pre-requisite information.
```{r, warning=FALSE}
dfres <- PMXForest::getForestDFFREM(dfCovs = dfCovs,
                     noBaseThetas = 6,
                     noCovThetas = length(covNames$covNames),
                     noSigmas = 2,
                     dfParameters=dfParameters,covNames=covNames,
                     functionList=functionList,functionListName=functionListName,
                     quiet=TRUE)

print(dfres)
```

Each row in the output corresponds to an error bar in the forest plot. Grouping of the covariates are automatically detected based on `dfCovs` and visible in the `GROUP` column. 
`REFFUNC` and `REFTRUE` are all based on the reference set of covariates (no covariates per default) and per default based on the median and then final parameter estimate (assuming dfParameters first row is the final estimates). 
A default row-name is created and available in the `COVNAME` column and based on the information in `dfCovs`.
The columns `q1` and `q2` are per default the 95\% confidence interval for the covariate values and  `FUNC` is the median value (per default). A version of `q1`, `q2` and  `FUNC` without assuming variability in the reference is also available in the `...NOVAR` columns. 
`COVEFF` is a column that automatically tries to detect if the covariate combination has any effect compared to the reference and can be used to e.g. subset the forest data before plotting the forest plot.
The `dfCovs` information is also included for each row.


## Create the Forest plot

The `plotForestDF` function takes the `getForestDFFREM()` output to produce the Forest plot.


```{r, fig1,fig.height = 4, fig.width = 16, fig.align="center", out.width=700, out.height=175}
theme_set(theme_bw(base_size=16)) #Change ggplot defaults to get nice plot
# PMXForest::plotForestDF(dfres,textsize=5)+xlim(c(0,2.5))
PMXForest::forestPlot(dfres)#+xlim(c(0,2.5))
```



